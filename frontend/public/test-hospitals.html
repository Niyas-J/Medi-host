<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hospital API Test - Quick Diagnostic</title>
    <style>
        body {
            font-family: monospace;
            padding: 20px;
            background: #1a1a1a;
            color: #0f0;
        }
        .status { padding: 10px; margin: 10px 0; background: #000; border: 1px solid #0f0; }
        .error { color: #f00; border-color: #f00; }
        .success { color: #0f0; border-color: #0f0; }
        button { 
            padding: 15px 30px; 
            font-size: 16px; 
            background: #0f0; 
            border: none; 
            cursor: pointer;
            margin: 10px 5px;
        }
        button:hover { background: #0c0; }
        pre { background: #000; padding: 10px; overflow-x: auto; }
    </style>
</head>
<body>
    <h1>üè• HOSPITAL API DIAGNOSTIC TEST</h1>
    
    <button onclick="testLocation()">1Ô∏è‚É£ TEST LOCATION</button>
    <button onclick="testGeoapify()">2Ô∏è‚É£ TEST GEOAPIFY API</button>
    <button onclick="testOverpass()">3Ô∏è‚É£ TEST OVERPASS API</button>
    <button onclick="testBangalore()">4Ô∏è‚É£ TEST BANGALORE (Known Location)</button>
    
    <div id="results"></div>

    <script>
        const API_KEY = 'dc461739b87042228f6be3ee0e2bf02a';
        let userLat = null;
        let userLon = null;

        function log(message, type = 'status') {
            const div = document.createElement('div');
            div.className = `status ${type}`;
            div.innerHTML = message;
            document.getElementById('results').appendChild(div);
            console.log(message);
        }

        function testLocation() {
            document.getElementById('results').innerHTML = '';
            log('üîç Testing Location Detection...', 'status');
            
            if (!navigator.geolocation) {
                log('‚ùå Geolocation NOT supported', 'error');
                return;
            }

            navigator.geolocation.getCurrentPosition(
                (position) => {
                    userLat = position.coords.latitude;
                    userLon = position.coords.longitude;
                    log(`‚úÖ LOCATION DETECTED!`, 'success');
                    log(`üìç Latitude: ${userLat}`, 'success');
                    log(`üìç Longitude: ${userLon}`, 'success');
                    log(`üìè Accuracy: ${position.coords.accuracy} meters`, 'success');
                    log(`üîó Google Maps: <a href="https://www.google.com/maps?q=${userLat},${userLon}" target="_blank">View on Map</a>`, 'success');
                    log('‚úÖ Now click "TEST GEOAPIFY API" to find hospitals', 'success');
                },
                (error) => {
                    log(`‚ùå Location Error: ${error.message}`, 'error');
                    log(`Error Code: ${error.code}`, 'error');
                    if (error.code === 1) {
                        log('üîß FIX: Click üîí icon in address bar ‚Üí Allow Location ‚Üí Refresh', 'error');
                    }
                },
                {
                    enableHighAccuracy: true,
                    timeout: 15000,
                    maximumAge: 0
                }
            );
        }

        async function testGeoapify() {
            if (!userLat || !userLon) {
                log('‚ö†Ô∏è Run "TEST LOCATION" first!', 'error');
                return;
            }

            document.getElementById('results').innerHTML = '';
            log('üîç Testing Geoapify API...', 'status');
            log(`üìç Searching near: ${userLat}, ${userLon}`, 'status');

            const categories = 'healthcare.hospital,healthcare.clinic,healthcare.pharmacy,commercial.chemist';
            const radius = 20000; // 20km
            const url = `https://api.geoapify.com/v2/places?categories=${categories}&filter=circle:${userLon},${userLat},${radius}&limit=50&apiKey=${API_KEY}`;

            log(`üì° API URL: ${url.substring(0, 100)}...`, 'status');

            try {
                const response = await fetch(url);
                log(`üì° Response Status: ${response.status} ${response.statusText}`, response.ok ? 'success' : 'error');

                const data = await response.json();
                log(`üìä Raw Response:`, 'status');
                log(`<pre>${JSON.stringify(data, null, 2).substring(0, 1000)}...</pre>`, 'status');

                if (data.features && data.features.length > 0) {
                    log(`‚úÖ FOUND ${data.features.length} FACILITIES!`, 'success');
                    data.features.slice(0, 5).forEach((f, i) => {
                        const name = f.properties.name || f.properties.address_line1 || 'Unknown';
                        const address = f.properties.address_line2 || f.properties.city || '';
                        const dist = f.properties.distance ? (f.properties.distance / 1000).toFixed(1) : '?';
                        log(`${i + 1}. ${name} - ${address} (${dist} km)`, 'success');
                    });
                } else {
                    log('‚ùå NO FACILITIES FOUND', 'error');
                    log('‚ö†Ô∏è Your location might be in a rural area with limited data', 'error');
                    log('üîß TRY: Click "TEST BANGALORE" to verify API works', 'error');
                }
            } catch (error) {
                log(`‚ùå API ERROR: ${error.message}`, 'error');
                log(`üîß Check: API key, internet connection, CORS`, 'error');
            }
        }

        async function testOverpass() {
            if (!userLat || !userLon) {
                log('‚ö†Ô∏è Run "TEST LOCATION" first!', 'error');
                return;
            }

            document.getElementById('results').innerHTML = '';
            log('üîç Testing Overpass API (OpenStreetMap)...', 'status');

            const radius = 20000;
            const query = `
                [out:json][timeout:25];
                (
                  node["amenity"="hospital"](around:${radius},${userLat},${userLon});
                  node["amenity"="clinic"](around:${radius},${userLat},${userLon});
                  node["amenity"="pharmacy"](around:${radius},${userLat},${userLon});
                );
                out body;
            `;

            try {
                const response = await fetch('https://overpass-api.de/api/interpreter', {
                    method: 'POST',
                    body: query
                });

                const data = await response.json();
                log(`‚úÖ Overpass Response: ${data.elements.length} results`, data.elements.length > 0 ? 'success' : 'error');
                
                if (data.elements.length > 0) {
                    data.elements.slice(0, 5).forEach((el, i) => {
                        log(`${i + 1}. ${el.tags.name || 'Unnamed'} (${el.tags.amenity})`, 'success');
                    });
                } else {
                    log('‚ùå NO FACILITIES FOUND via Overpass', 'error');
                }
            } catch (error) {
                log(`‚ùå Overpass API ERROR: ${error.message}`, 'error');
            }
        }

        async function testBangalore() {
            document.getElementById('results').innerHTML = '';
            log('üîç Testing Bangalore (Known location with many hospitals)...', 'status');

            const lat = 12.9716;
            const lon = 77.5946;
            const categories = 'healthcare.hospital,healthcare.clinic';
            const radius = 5000;
            const url = `https://api.geoapify.com/v2/places?categories=${categories}&filter=circle:${lon},${lat},${radius}&limit=20&apiKey=${API_KEY}`;

            try {
                const response = await fetch(url);
                const data = await response.json();

                if (data.features && data.features.length > 0) {
                    log(`‚úÖ API WORKS! Found ${data.features.length} hospitals in Bangalore`, 'success');
                    data.features.slice(0, 5).forEach((f, i) => {
                        const name = f.properties.name || f.properties.address_line1;
                        log(`${i + 1}. ${name}`, 'success');
                    });
                    log('‚úÖ Your API key is valid!', 'success');
                    log('‚ö†Ô∏è Issue is likely: Your location has limited hospital data', 'error');
                } else {
                    log('‚ùå Even Bangalore returned no results - API KEY ISSUE?', 'error');
                }
            } catch (error) {
                log(`‚ùå ERROR: ${error.message}`, 'error');
            }
        }

        // Auto-run location test on load
        window.onload = () => {
            log('‚úÖ Test page loaded. Click buttons above to diagnose.', 'success');
        };
    </script>
</body>
</html>

